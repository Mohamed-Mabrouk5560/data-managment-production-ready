<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث عن سجل</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <!-- AppBar -->
        <header class="app-bar">
            <div class="welcome-msg" id="welcome-message-header">مرحباً بك</div>
            <div class="app-bar-actions">
                <button class="aside-toggle" onclick="toggleMenu()">☰</button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">نظام البيانات</div>
            <ul class="sidebar-nav">
                <li><a href="form.html">إدخال البيانات</a></li>
                <li><a href="search.html" class="active">البحث عن سجل</a></li>
                <li><a href="#" onclick="logout()">تسجيل الخروج</a></li>
            </ul>
        </aside>

        <!-- Main content -->
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title">البحث عن سجل</h1>
                    <p class="card-subtitle">أدخل الرقم القومي للبحث</p>
                </div>

                <form id="search-form" onsubmit="handleSearch(event)">
                    <div class="search-row">
                        <div class="form-group search-field">
                            <label class="form-label" for="search-national-id">الرقم القومي (14 رقم)</label>
                            <input type="text" id="search-national-id" class="form-input" required pattern="\d{14}"
                                maxlength="14" placeholder="12345678901234">
                        </div>
                        <div class="search-btn-container">
                            <button type="submit" class="btn btn-primary" id="search-btn" style="min-width: 120px;">
                                بحث
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Initial Placeholder -->
            <div id="initial-placeholder" class="card placeholder-container">
                <svg class="placeholder-vector" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5">
                    <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <p class="placeholder-text">أدخل الرقم القومي لبدء البحث عن سجل</p>
            </div>

            <!-- Search results -->
            <div id="search-results" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">نتائج البحث</h2>
                    </div>

                    <div id="record-details"></div>
                </div>
            </div>

            <!-- No results message -->
            <div id="no-results" class="card placeholder-container hidden">
                <svg class="placeholder-vector" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5">
                    <path d="M9.172 9.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="placeholder-text">عذراً، لم يتم العثور على سجل بهذا الرقم القومي</p>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            window.location.href = 'index.html';
        }

        // Set welcome message
        const userEmail = getUserEmail();
        if (userEmail) {
            document.getElementById('welcome-message-header').textContent = `مرحباً بك، ${userEmail}`;
        }

        // Toggle mobile menu
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Handle search
        async function handleSearch(event) {
            event.preventDefault();

            const nationalId = document.getElementById('search-national-id').value;
            const btn = document.getElementById('search-btn');
            const resultsDiv = document.getElementById('search-results');
            const noResultsDiv = document.getElementById('no-results');
            const initialDiv = document.getElementById('initial-placeholder');

            // Hide previous results and initial placeholder
            resultsDiv.classList.add('hidden');
            noResultsDiv.classList.add('hidden');
            if (initialDiv) initialDiv.classList.add('hidden');

            // Show loading state
            btn.disabled = true;
            btn.classList.add('btn-loading');
            btn.textContent = '';

            const result = await searchByNationalId(nationalId);

            // Reset button
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.textContent = 'بحث';

            if (result.success && result.data) {
                displayRecord(result.data);
                resultsDiv.classList.remove('hidden');
            } else if (result.success && !result.data) {
                noResultsDiv.classList.remove('hidden');
            } else {
                showToast(result.message, 'error');
            }
        }

        // Display record details
        function displayRecord(record) {
            const detailsDiv = document.getElementById('record-details');

            const fields = [
                { label: 'التاريخ', key: 'Timestamp' },
                { label: 'الاسم رباعي', key: 'الاسم رباعي' },
                { label: 'رقم التليفون', key: 'رقم التليفون' },
                { label: 'القرية', key: 'القرية' },
                { label: 'المحافظة', key: 'المحافظة' },
                { label: 'الرقم القومي', key: 'الرقم القومي' },
                { label: 'نوع الاعاقة', key: 'نوع الاعاقة' },
                { label: 'دليل القرية', key: 'دليل القرية' },
                { label: 'رقم دليل القرية', key: 'رقم دليل القرية' },
                { label: 'المركز الطبي الشريك', key: 'المركز الطبي الشريك' },
                { label: 'الخدمة', key: 'الخدمة' },
                { label: 'فورتي موكس', key: 'فورتي موكس' },
                { label: 'الشركة الشريكة بتنفيذ النظارات', key: 'الشركة الشريكة بتنفيذ النظارات' },
                { label: 'رقم مسؤول الشركة', key: 'رقم مسؤول الشركة' },
                { label: 'الملاحظات الخاصة بتنفيذ النظارات', key: 'الملاحظات الخاصة بتنفيذ النظارات' },
                { label: 'المركز والشريك الطبي', key: 'المركز والشريك الطبي' },
                { label: 'الجهة', key: 'الجهة' },
                { label: 'الملاحظات للعمليات', key: 'الملاحظات للعمليات' },
                { label: 'الكود', key: 'الكود' }
            ];

            let html = '<div style="display: grid; gap: 1rem;">';

            fields.forEach(field => {
                const value = record[field.key] || '-';
                html += `
          <div style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
            <div style="font-weight: 600; color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem;">
              ${field.label}
            </div>
            <div style="color: var(--text-primary);">
              ${value}
            </div>
          </div>
        `;
            });

            html += '</div>';
            detailsDiv.innerHTML = html;
        }
    </script>
</body>

</html>